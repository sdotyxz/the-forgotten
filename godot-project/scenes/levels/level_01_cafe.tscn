[gd_scene load_steps=8 format=3 uid="uid://cafe01cafe01"]

[ext_resource type="PackedScene" uid="uid://floor01" path="res://assets/models/kaykit_restaurant/floor_kitchen.gltf" id="floor_kitchen"]
[ext_resource type="PackedScene" uid="uid://wall01" path="res://assets/models/kaykit_restaurant/wall.gltf" id="wall"]
[ext_resource type="PackedScene" uid="uid://wallwin01" path="res://assets/models/kaykit_restaurant/wall_window_closed.gltf" id="wall_window"]

[sub_resource type="Environment" id="Environment_cafe01"]
background_color = Color(0.2, 0.2, 0.25, 1)
ambient_light_source = 2
ambient_light_color = Color(0.4, 0.4, 0.45, 1)
ambient_light_energy = 0.3

[sub_resource type="GDScript" id="GDScript_camera_rot"]
script/source = "extends Camera3D

var start_time = 0
const ROTATION_DURATION = 8.0
const START_ANGLE = PI / 4.0
const END_ANGLE = 5.0 * PI / 4.0
const RADIUS = 14.14
const HEIGHT = 10.0

func _ready():
    start_time = Time.get_ticks_msec()
    # 设置初始位置
    update_camera_position(0.0)

func _process(_delta):
    var elapsed = (Time.get_ticks_msec() - start_time) / 1000.0
    if elapsed > ROTATION_DURATION:
        return
    
    var t = elapsed / ROTATION_DURATION
    # 使用 smoothstep 让开始和结束更平滑
    t = t * t * (3.0 - 2.0 * t)
    
    update_camera_position(t)

func update_camera_position(t: float):
    var angle = START_ANGLE + (END_ANGLE - START_ANGLE) * t
    
    var x = RADIUS * cos(angle)
    var z = RADIUS * sin(angle)
    
    position = Vector3(x, HEIGHT, z)
    
    # 使用更稳定的 look_at 方法
    var target = Vector3.ZERO
    var up = Vector3.UP
    
    # 避免万向节锁：当视线接近垂直时调整 up 向量
    var forward = (target - position).normalized()
    if abs(forward.dot(Vector3.UP)) > 0.99:
        up = Vector3.FORWARD
    
    look_at(target, up)
"

[node name="CafeScene" type="Node3D"]

[node name="Floor" type="Node3D" parent="."]

[node name="floor_kitchen" parent="Floor" instance=ExtResource("floor_kitchen")]
transform = Transform3D(10, 0, 0, 0, 1, 0, 0, 0, 10, 0, 0, 0)

[node name="BackWall" type="Node3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, -10)

[node name="wall" parent="BackWall" instance=ExtResource("wall")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0)

[node name="LeftWall" type="Node3D" parent="."]
transform = Transform3D(-4.37114e-08, 0, 1, 0, 1, 0, -1, 0, -4.37114e-08, -10, 0, 0)

[node name="wall_window" parent="LeftWall" instance=ExtResource("wall_window")]

[node name="RightWall" type="Node3D" parent="."]
transform = Transform3D(-4.37114e-08, 0, 1, 0, 1, 0, -1, 0, -4.37114e-08, 10, 0, 0)

[node name="wall2" parent="RightWall" instance=ExtResource("wall")]

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(0.707107, 0.408248, -0.57735, 0, 0.816497, 0.57735, 0.707107, -0.408248, 0.57735, 10, 10, 10)
projection = 1
size = 15.0
fov = 75.0
near = 0.01
far = 1000.0
script = SubResource("GDScript_camera_rot")

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_cafe01")

[node name="KeyLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(0.707107, -0.408248, 0.57735, 0, 0.816497, 0.57735, -0.707107, -0.408248, 0.57735, 10, 10, 5)
light_energy = 1.0
shadow_enabled = true
shadow_bias = 0.02
shadow_normal_bias = 1.0
directional_shadow_max_distance = 10.0
directional_shadow_split_1 = 0.1
directional_shadow_split_2 = 0.3
directional_shadow_split_3 = 0.6

[node name="FillLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(-0.919145, -0.368449, 0.140292, 0, 0.356822, 0.934172, -0.393919, 0.858631, -0.327971, -5, 5, 5)
light_energy = 0.4
shadow_enabled = true
shadow_bias = 0.05

[node name="RimLight" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -0.447214, 0.894427, 0, -0.894427, -0.447214, 0, 5, -10)
light_energy = 0.6
shadow_enabled = true
shadow_bias = 0.05

[node name="BarArea" type="Node3D" parent="."]

[node name="Tables" type="Node3D" parent="."]

[node name="Customers" type="Node3D" parent="."]

[node name="Windows" type="Node3D" parent="."]

[node name="HiddenItems" type="Node3D" parent="."]
